syntax = "proto3";

package instill.pipeline.v1alpha;

// Protocol Buffers Well-Known Types
import "google/protobuf/struct.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";

// Google API
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

// HealthCheckRequest represents a request to health check a service
message HealthCheckRequest {
  // Service name to check for its readiness status
  string service = 1 [ (google.api.field_behavior) = OPTIONAL ];
}

// HealthCheckResponse represents a response for a service heath status
message HealthCheckResponse {
  // ServingStatus enumerates the status of a queried service
  enum ServingStatus {
    // Serving status: UNSPECIFIED
    SERVING_STATUS_UNSPECIFIED = 0;
    // Serving status: SERVING
    SERVING_STATUS_SERVING = 1;
    // Serving status: NOT SERVING
    SERVING_STATUS_NOT_SERVING = 2;
  }

  // Status is the instance of the enum type ServingStatus
  ServingStatus status = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// LivenessRequest represents a request to check a service liveness status
message LivenessRequest {
  // HealthCheckRequest message
  HealthCheckRequest health_check_request = 1
      [ (google.api.field_behavior) = OPTIONAL ];
}

// LivenessResponse represents a response for a service liveness status
message LivenessResponse {
  // HealthCheckResponse message
  HealthCheckResponse health_check_response = 1
      [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// ReadinessRequest represents a request to check a service readiness status
message ReadinessRequest {
  // HealthCheckRequest message
  HealthCheckRequest health_check_request = 1
      [ (google.api.field_behavior) = OPTIONAL ];
}

// ReadinessResponse represents a response for a service readiness status
message ReadinessResponse {
  // HealthCheckResponse message
  HealthCheckResponse health_check_response = 1
      [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// Source represents a source connector
message Source {
  // Source name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// Destination represents a destination connector
message Destination {
  // Destination name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// Model represents the content of a model
message Model {
  // Model name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance name
  string instance_name = 2 [ (google.api.field_behavior) = REQUIRED ];
}

// Logic represents the content of a logic operator
message Logic {}

// Recipe represents the content of a recipe
message Recipe {
  // A source connector instance
  Source source = 1 [ (google.api.field_behavior) = REQUIRED ];
  // A destination connector instance
  Destination destination = 2 [ (google.api.field_behavior) = REQUIRED ];
  // A list of model instances
  repeated Model models = 3 [ (google.api.field_behavior) = REQUIRED ];
  // A list of logic instances
  repeated Logic logics = 4 [ (google.api.field_behavior) = REQUIRED ];
}

// Pipeline represents the content of a pipeline
message Pipeline {

  // Mode enumerates the pipeline modes
  enum Mode {
    // Mode: UNSPECIFIED
    MODE_UNSPECIFIED = 0;
    // Mode: SYNC
    MODE_SYNC = 1;
    // Mode: ASYNC
    MODE_ASYNC = 2;
  }

  // Status enumerates the status of a pipeline
  enum Status {
    // Status: UNSPECIFIED
    STATUS_UNSPECIFIED = 0;
    // Status: INACTIVATED
    STATUS_INACTIVATED = 1;
    // Status: ACTIVATED
    STATUS_ACTIVATED = 2;
    // Status: ERROR
    STATUS_ERROR = 3;
  }

  // Pipeline resource name. It must have the format of "pipelines/*"
  string name = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Pipeline UUID
  string id = 2 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Pipeline display name
  string display_name = 3 [ (google.api.field_behavior) = REQUIRED ];
  // Pipeline description
  optional string description = 4 [ (google.api.field_behavior) = OPTIONAL ];
  // Pipeline recipe
  Recipe recipe = 5 [ (google.api.field_behavior) = REQUIRED ];
  // Pipeline mode
  Mode mode = 6 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Pipeline status
  Status status = 7 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Connector owner UUID
  string owner_id = 8 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Connector full name (i.e., owner_name/pipeline_name)
  string full_name = 9 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Pipeline creation time
  google.protobuf.Timestamp create_time = 10
      [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Pipeline update time
  google.protobuf.Timestamp update_time = 11
      [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// CreatePipelineRequest represents a request to create a pipeline
message CreatePipelineRequest {
  // Pipeline instance
  Pipeline pipeline = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// CreatePipelineResponse represents a response for a pipeline instance
message CreatePipelineResponse {
  // A pipeline instance
  Pipeline pipeline = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// PipelineView enumerates the pipeline views
enum PipelineView {
  // PipelineView: UNSPECIFIED
  PIPELINE_VIEW_UNSPECIFIED = 0;
  // PipelineView: BASIC
  PIPELINE_VIEW_BASIC = 1;
  // PipelineView: FULL
  PIPELINE_VIEW_FULL = 2;
}

// ListPipelineRequest represents a request to list pipelines
message ListPipelineRequest {
  // Page size
  int32 page_size = 1 [ (google.api.field_behavior) = OPTIONAL ];
  // Page token
  string page_token = 2 [ (google.api.field_behavior) = OPTIONAL ];
  // PipelineView view (default is PIPELINE_VIEW_BASIC)
  PipelineView view = 3 [ (google.api.field_behavior) = OPTIONAL ];
}

// ListPipelineResponse represents a response for a list of pipelines
message ListPipelineResponse {
  // A list of pipeline instances
  repeated Pipeline pipelines = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Next page token
  string next_page_token = 2 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// GetPipelineRequest represents a request to query a pipeline
message GetPipelineRequest {
  // Pipeline resource name. It must have the format of "pipelines/*"
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // PipelineView view (default is PIPELINE_VIEW_BASIC)
  PipelineView view = 2 [ (google.api.field_behavior) = OPTIONAL ];
}

// GetPipelineResponse represents a response for a pipeline instance
message GetPipelineResponse {
  // A pipeline instance
  Pipeline pipeline = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// UpdatePipelineRequest represents a request to update a pipeline
message UpdatePipelineRequest {
  // Pipeline instance to update
  Pipeline pipeline = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Update mask for a pipeline instance
  google.protobuf.FieldMask update_mask = 2;
}

// UpdatePipelineResponse represents a response for a pipeline instance
message UpdatePipelineResponse {
  // A pipeline instance
  Pipeline pipeline = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// DeletePipelineRequest represents a request to delete a pipeline
message DeletePipelineRequest {
  // Pipeline resource name. It must have the format of "pipelines/*"
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// DeletePipelineResponse represents an empty response
message DeletePipelineResponse {}

// Input represents the input to a pipeline
message Input {
  // Input type
  oneof type {
    // Image type URL
    string image_url = 1;
    // Image type base64
    string image_base64 = 2;
  }
}

// TriggerPipelineRequest represents a request to trigger a pipeline
message TriggerPipelineRequest {
  // Pipeline resource name. It must have the format of "pipelines/*"
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Input to the pipeline
  repeated Input inputs = 2 [ (google.api.field_behavior) = REQUIRED ];
}

// TriggerPipelineResponse represents a response for the output of a pipeline
message TriggerPipelineResponse {
  // Output from a pipeline
  google.protobuf.Struct output = 1;
}

// TriggerPipelineBinaryFileUploadRequest represents a request to trigger a
// pipeline
message TriggerPipelineBinaryFileUploadRequest {
  // Pipeline resource name. It must have the format of "pipelines/*"
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Pipeline content in bytes
  bytes bytes = 2 [ (google.api.field_behavior) = REQUIRED ];
}

// TriggerPipelineBinaryFileUploadResponse represents a response for the output
// of a pipeline
message TriggerPipelineBinaryFileUploadResponse {
  // Output from a pipeline
  google.protobuf.Struct output = 1;
}

// Pipeline service responds to incoming pipeline requests.
service PipelineService {

  // Liveness method receives a LivenessRequest message and returns a
  // LivenessResponse message.
  // See https://github.com/grpc/grpc/blob/master/doc/health-checking.md
  rpc Liveness(LivenessRequest) returns (LivenessResponse) {
    option (google.api.http) = {
      get : "/__liveness"
      additional_bindings : [ {get : "/health/pipeline"} ]
    };
  }

  // Readiness method receives a ReadinessRequest message and returns a
  // ReadinessResponse message.
  // See https://github.com/grpc/grpc/blob/master/doc/health-checking.md
  rpc Readiness(ReadinessRequest) returns (ReadinessResponse) {
    option (google.api.http) = {
      get : "/__readiness"
    };
  }

  // CreatePipeline method receives a CreatePipelineRequest message and returns
  // a CreatePipelineResponse message.
  rpc CreatePipeline(CreatePipelineRequest) returns (CreatePipelineResponse) {
    option (google.api.http) = {
      post : "/pipelines"
      body : "pipeline"
    };
  }

  // ListPipeline method receives a ListPipelineRequest message and returns a
  // ListPipelineResponse message.
  rpc ListPipeline(ListPipelineRequest) returns (ListPipelineResponse) {
    option (google.api.http) = {
      get : "/pipelines"
    };
  }

  // GetPipeline method receives a GetPipelineRequest message and returns a
  // GetPipelineResponse message.
  rpc GetPipeline(GetPipelineRequest) returns (GetPipelineResponse) {
    option (google.api.http) = {
      get : "/{name=pipelines/*}"
    };
  }

  // UpdatePipeline method receives a UpdatePipelineRequest message and returns
  // a UpdatePipelineResponse message.
  rpc UpdatePipeline(UpdatePipelineRequest) returns (UpdatePipelineResponse) {
    option (google.api.http) = {
      patch : "/{pipeline.name=pipelines/*}"
      body : "pipeline"
    };
  }

  // UpdatePipeline method receives a DeletePipelineRequest message and returns
  // a DeletePipelineResponse message.
  rpc DeletePipeline(DeletePipelineRequest) returns (DeletePipelineResponse) {
    option (google.api.http) = {
      delete : "/{name=pipelines/*}"
    };
  }

  // TriggerPipeline method receives a TriggerPipelineRequest message and
  // returns a TriggerPipelineResponse.
  rpc TriggerPipeline(TriggerPipelineRequest)
      returns (TriggerPipelineResponse) {
    option (google.api.http) = {
      post : "/pipelines/{name}/outputs"
      body : "*"
    };
  }

  // TriggerPipelineBinaryFileUpload method receives a
  // TriggerPipelineBinaryFileUploadRequest message and returns a
  // TriggerPipelineBinaryFileUploadResponse message.
  rpc TriggerPipelineBinaryFileUpload(
      stream TriggerPipelineBinaryFileUploadRequest)
      returns (TriggerPipelineBinaryFileUploadResponse) {}
}
